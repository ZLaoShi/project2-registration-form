### **后端功能总览**

以下是完整后端实现的功能，涵盖报名系统的核心逻辑、权限控制、项目管理、数据导出等。

------

### **1. 用户与权限管理**

#### **1.1 用户注册**

- **目标**：允许新用户创建账户，临时用户转为正式用户。
  - 用户名、密码（存储为哈希值）、角色（普通用户或管理员），邮箱（用于注册和识别）。
- 权限限制
  - 注册时默认角色为普通用户。
  - 管理员账户只能通过进入数据库手动修改字段。

#### **1.2 用户登录**

- **目标**：通过用户名和密码登录，生成会话或令牌。
- 数据要求
  - 验证用户名和密码是否匹配。
- 返回结果
  - 成功时生成一个令牌（JWT 或其他形式），用于后续的 API 访问。

#### **1.3 权限控制**

- **目标**：基于用户角色控制不同 API 的访问权限。
- 权限划分
  - **普通用户**：只能提交报名信息，无法查看或导出数据。
  - **临时用户**：通过填写联系方式报名，提供查询 key 查看自己的报名信息，并选项是否允许通过联系方式查询。
  - **管理员**：可以查看、修改、删除报名数据，管理项目，以及访问导出功能。

------

### **2. 报名管理**

#### **2.1 提交报名**

- **目标**：普通用户和临时用户提交报名信息。
- 数据要求
  - 临时用户：姓名、联系方式、报名项目，以及是否同意通过联系方式查询报名信息。
  - 普通用户：姓名、联系方式、报名项目，以及是否同意通过联系方式查询报名信息。。
- 返回结果
  - 返回成功提交的信息，报名成功生成的查询 key 和时间戳。

#### **2.2 查询报名**

- **目标**：允许管理员或用户查询报名数据。
- 查询范围
  - **普通用户**：仅能查看自己的报名信息。
  - **临时用户**：仅能查看自己的报名信息。
  - **管理员**：可以查看所有报名信息。
- 支持功能
  - 按日期范围、项目或姓名筛选。
  - 支持分页与排序。

#### **2.3 修改报名**状态

- **目标**：修改指定报名记录的状态。
- 权限限制
  - 管理员可以任意修改记录的报名状态。
  - 普通用户可以取消自己的报名。
  - 临时用户可以通过验证码验证后修改报名状态，可以取消自己的报名。

------

### **3. 报名项目管理**

#### **3.1 创建项目**

- **目标**：管理员添加新项目。
- 数据要求
  - 项目名称。
  - 项目描述。
  - 项目开始时间、结束时间。
  - 是否启用（状态标记）。
- 返回结果
  - 返回成功创建的项目 ID 和其他信息。

#### **3.2 查询项目**

- **目标**：允许管理员查看所有项目。
- 支持功能
  - 按项目名称筛选。
  - 支持分页与排序。

#### **3.3 修改项目**

- **目标**：管理员更新现有项目的信息。
- 数据要求
  - 提交需要修改的项目 ID 和更新后的数据。
- 权限限制
  - 只有管理员可以执行该操作。

#### **3.4 删除项目**

- **目标**：管理员删除指定项目。
- 数据要求
  - 根据唯一标识（项目 ID）删除项目。
- 注意事项
  - 删除项目前需检查是否有已报名用户关联该项目，并提示可能的影响。

**3.5 项目自动过期** //未完成

- **目标**： 项目到达设定结束日期后自动进入不可报名状态。

------

### **4. 数据导出**

#### **4.1 导出 Excel 文件**

- **目标**：生成包含报名数据的 Excel 表格。
- 支持功能
  - 表头包括报名信息字段（ID、姓名、联系方式、项目等）。
  - 支持按时间范围、项目筛选导出。

#### **4.3 安全性**

- **目标**：仅允许管理员下载导出文件。
- 敏感信息处理 //未完成
  - 可选择脱敏导出（如隐藏联系方式的部分内容）。

------

### **5. 系统管理与优化**

#### **5.1 数据存储**

- 数据库结构
  - 用户表：存储用户账户信息。
  - 报名表：存储所有报名记录。
  - 项目表：存储项目信息。
  - 邮件队列表：邮件存档。
- 主数据库
  - 使用 SQLite3 数据库存储用户，报名，项目和邮件信息。

#### **5.2性能优化**

- 分页与批量处理
  - 对大规模数据查询或导出支持分页，避免超时。
- 索引优化
  - 为关键字段（如项目名称、报名时间）添加索引。

------

### **6. 安全性要求**

#### **6.1 身份验证**

- 使用 JWT 令牌进行身份验证，确保所有非公开 API 的安全性。

#### **6.2 数据访问权限**

- 根据用户角色控制访问权限，确保数据的安全性。

#### **6.3 数据完整性**

- 验证用户输入的数据格式（如联系方式、时间范围）。

#### **6.4 日志记录**

- 记录所有敏感操作（如删除项目、报名数据）的日志，便于审计。

------

### **7. 部署与运维**

#### **7.1 Docker 容器化**

- 使用 Docker 容器管理后端服务、SQLite 和 Redis。

#### **7.2 配置管理**

- 使用 `.env` 文件统一管理环境变量。

------

## 数据库设计

### **1. 用户表（users）**

存储用户的账户信息，包括普通用户、管理员及临时用户。

| 字段名       | 类型     | 描述                                 |
| ------------ | -------- | ------------------------------------ |
| `id`         | BIGINT   | 用户唯一标识，主键，自增             |
| `username`   | TEXT     | 用户名，唯一                         |
| `password`   | TEXT     | 哈希后的密码                         |
| `email`      | TEXT     | 用户邮箱，唯一                       |
| `role`       | TEXT     | 用户角色（普通用户/管理员/临时用户） |
| `created_at` | DATETIME | 账户创建时间                         |
| `updated_at` | DATETIME | 账户更新时间                         |

#### **索引：**

- `username` 和 `email` 字段有索引以加速查询。

### **2. 项目表（projects）**

存储项目的基本信息，供用户报名使用。

| 字段名        | 类型     | 描述                     |
| ------------- | -------- | ------------------------ |
| `id`          | BIGINT   | 项目唯一标识，主键，自增 |
| `name`        | TEXT     | 项目名称，唯一           |
| `description` | TEXT     | 项目描述                 |
| `start_date`  | DATETIME | 项目开始日期             |
| `end_date`    | DATETIME | 项目结束日期             |
| `is_enabled`  | TINYINT  | 项目是否启用             |
| `created_at`  | DATETIME | 创建时间                 |
| `updated_at`  | DATETIME | 更新时间                 |

#### **索引：**

- `is_enabled` 字段索引：帮助快速查询启用/禁用的项目。
- `name` 字段唯一索引：确保项目名称唯一。

### **3. 报名表（registrations）**

存储所有用户的报名记录。

| 字段名                     | 类型     | 描述                              |
| -------------------------- | -------- | --------------------------------- |
| `id`                       | BIGINT   | 报名唯一标识，主键，自增          |
| `user_id`                  | BIGINT   | 用户 ID，外键，关联 `users` 表    |
| `project_id`               | BIGINT   | 项目 ID，外键，关联 `projects` 表 |
| `name`                     | TEXT     | 报名者姓名                        |
| `contact_info`             | TEXT     | 联系方式（如手机号或邮箱）        |
| `query_key`                | TEXT     | 查询 key（生成后返回给临时用户）  |
| `is_contact_query_allowed` | BOOLEAN  | 是否允许通过联系方式查询信息      |
| `created_at`               | DATETIME | 报名提交时间                      |
| `status`                   | INTEGER  | 报名状态（待审核、已审核等）      |

#### **索引：**

- `user_id` 字段索引：加速根据用户查询报名记录。
- `project_id` 字段索引：加速根据项目查询报名记录。
- `query_key` 字段唯一索引：确保查询 key 唯一。

### **4. 邮件队列表（mail_queue）**

存储发送邮件的记录。

| 字段名       | 类型     | 描述                           |
| ------------ | -------- | ------------------------------ |
| `id`         | BIGINT   | 邮件记录唯一标识，主键，自增   |
| `recipient`  | TEXT     | 收件人邮箱地址                 |
| `subject`    | TEXT     | 邮件主题                       |
| `content`    | TEXT     | 邮件内容                       |
| `status`     | TEXT     | 邮件状态（如：待发送、已发送） |
| `created_at` | DATETIME | 创建时间                       |

------

## 关系和外键约束

- `users` 表与 `registrations` 表之间存在一对多关系，`registrations.user_id` 外键引用 `users.id`。
- `projects` 表与 `registrations` 表之间也存在一对多关系，`registrations.project_id` 外键引用 `projects.id`。



---

## 后端技术栈

### **1. 核心框架与编程语言**

#### **1.1 编程语言**

- **TypeScript**

- ### **1.2 使用依赖**
  
  - **Hono**：用于构建 Web 应用的框架。
  - **Prisma**：ORM 工具，简化数据库操库。
  - **JWT**：用于身份认证和授权管理。
  - **Redis**：缓存系统，处理用户会话，避免频繁的数据库查询。
  - **Bcrypt**：用于密码哈希处理，保障用户密码安全。
  - **zod**：中间件的类型验证。
  - **Nodemailer**：用于邮件发送，支持邮箱验证等功能。
  - **ExcelJS**：用于 Excel 文件生成和处理，方便导出数据。

------

### **2. 数据存储与缓存**

#### **2.1 主数据库**

- SQLite3
  - 轻量级、嵌入式的关系型数据库。
  - 零配置，适合低并发场景项目。
  - 数据文件便于迁移和备份。

#### **2.2 缓存与任务队列**

- Redis
  - 登录信息缓存
    - 用于用户登录会话的高速验证。
    - 提供 TTL（过期时间）机制，实现自动会话过期清理。
  - 轻量邮件队列
    - 使用 Redis 的 `List` 数据结构，模拟消息队列。
    - 将邮件任务写入 Redis 列表，并由后台任务处理器异步消费。

------

### **3. 用户认证与权限管理**

#### **JWT（JSON Web Token）**

- 用途：
  - 用户登录生成和验证令牌。
  - 与 Redis 配合实现用户会话管理。

#### **权限分级**

- **普通用户**：提交，查看和修改自己的报名信息。
- **临时用户**：提交，查看和修改自己的信息。
- **管理员**：可以查看、修改、删除报名信息，项目信息，以及导入已报名列表。

------

### **4. 部署与环境管理**

#### **4.1 容器化管理**

- Docker
  - 容器化管理 Hono后端服务和 Redis 缓存服务。
  - 提供统一的部署环境，降低配置复杂度。
  - SQLite 数据库文件挂载到宿主机目录，确保数据持久化。

#### **4.2 环境变量管理**

- `.env` 文件
  - 管理敏感信息（如 Redis 地址、邮件账号授权码）。
  - 支持不同环境（开发、测试、生产）切换配置。

------

### **5. 安全性**

- Redis 配合加密令牌，确保会话安全。
- 数据验证与格式检查： //未完成
  - 对用户输入数据进行格式验证，避免非法数据注入。
- 敏感数据脱敏（如部分联系方式隐藏）。 //未完成

------

- ### **适用场景概述**

  - **小型项目**：
    - Redis 提供了轻量级的邮件队列支持，无需引入更复杂的消息队列方案，适合小规模任务。
    - SQLite 简化了数据库部署和管理，适合低并发场景，且无需专人维护。
  - **未来扩展**：
    - Redis 可扩展为更复杂的任务队列，同时支持高并发场景。
    - 考虑加入 RabbitMQ 实现邮件队列，进一步提升异步处理能力，满足大量邮件请求需求。

---

### 

### **项目规范**

以下是项目开发和维护的规范，以确保系统长期可用和可扩展。

------

#### **1. 代码规范**

1. **命名规范**：
   - 数据库表名使用复数（如 `users`、`registrations`）。
   - 变量和函数名采用驼峰命名法（如 `getUserById`）。
2. **代码风格**：
   - 遵循 TypeScript 的 ESLint 规则，保持代码一致性。
   - 使用模块化设计，每个功能模块对应一个文件夹和命名空间。
3. **注释与文档**：
   - 每个模块和核心函数提供注释说明。
   - 提供完整的 README 文档，说明部署流程。

------

#### **2. 数据库规范**

1. **主键设计**：
   - 所有表均使用雪花ID `INTEGER` 作为主键。
   - 外键字段通过 `ON DELETE CASCADE` 确保数据完整性。
2. **索引优化**：
   - 为以下字段添加索引：
     - `registrations.user_id`：提高用户报名信息查询效率。
     - `projects.is_enabled`：快速过滤启用中的项目。
3. **数据一致性**：
   - 所有时间字段采用 UTC 标准。
   - 报名记录和项目的外键关联必须符合约束条件。

------

暝涬无疆 

最后修改：2024.12.03 
